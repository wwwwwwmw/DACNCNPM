<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events - Lịch Công Tác</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Quản lý lịch công tác</h1>
    <div>
      <button class="btn btn-outline-secondary" onclick="logout()">Đăng xuất</button>
    </div>
  </div>

  <div class="row g-2 mb-3">
    <div class="col-md-3"><input type="date" id="from" class="form-control" /></div>
    <div class="col-md-3"><input type="date" id="to" class="form-control" /></div>
    <div class="col-md-3">
      <select id="status" class="form-select">
        <option value="">-- Tất cả trạng thái --</option>
        <option value="pending">Chờ duyệt</option>
        <option value="approved">Đã duyệt</option>
        <option value="rejected">Từ chối</option>
      </select>
    </div>
    <div class="col-md-3"><button id="filterBtn" class="btn btn-primary w-100">Lọc</button></div>
  </div>

  <div id='calendar'></div>
  <hr/>
  <h5 class="mt-4">Tạo lịch</h5>
  <div class="row g-2 align-items-end">
    <div class="col-md-3"><input id="title" class="form-control" placeholder="Tiêu đề" /></div>
    <div class="col-md-3"><input id="start" type="datetime-local" class="form-control" /></div>
    <div class="col-md-3"><input id="end" type="datetime-local" class="form-control" /></div>
    <div class="col-md-3">
      <select id="room" class="form-select"></select>
    </div>
    <div class="col-12">
      <label class="form-label">Người tham dự</label>
      <select multiple id="parts" class="form-select"></select>
      <div class="form-text">Giữ Ctrl/Command để chọn nhiều người.</div>
    </div>
    <div class="col-12 mt-2">
      <button id="createBtn" class="btn btn-success">Tạo</button>
      <a id="downloadIcs" class="btn btn-outline-secondary disabled" href="#">Tải .ics</a>
    </div>
  </div>

  <hr/>
  <div class="row g-2">
    <div class="col-auto">
      <input id="eventId" class="form-control" placeholder="Event ID" />
    </div>
    <div class="col-auto">
      <button id="approveBtn" class="btn btn-success">Duyệt</button>
      <button id="rejectBtn" class="btn btn-danger">Từ chối</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
<script src="../assets/js/main.js"></script>
<script>
let calendar;
async function fetchEvents(q={}) {
  const params = new URLSearchParams(q);
  const res = await api.get('/api/events?'+params.toString());
  return (res.data || []).map(e => ({
    id: e.id, title: e.title,
    start: e.start_time, end: e.end_time,
    backgroundColor: e.status === 'approved' ? '#16a34a' :
                     e.status === 'rejected' ? '#dc2626' : '#2563eb'
  }));
}
async function loadRoomsAndUsers() {
  const [r, u] = await Promise.all([api.get('/api/rooms'), api.get('/api/users?limit=1000')]);
  document.getElementById('room').innerHTML =
    '<option value="">-- Không chọn phòng --</option>' +
    (r.data||[]).map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  document.getElementById('parts').innerHTML =
    (u.data||[]).map(x=>`<option value="${x.id}">${x.name} - ${x.email}</option>`).join('');
}

document.addEventListener('DOMContentLoaded', async function() {
  await ensureLogin();
  await loadRoomsAndUsers();
  const calendarEl = document.getElementById('calendar');
  const events = await fetchEvents();
  calendar = new FullCalendar.Calendar(calendarEl, {
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
    initialView: 'dayGridMonth',
    events,
    eventClick: (info) => {
      document.getElementById('eventId').value = info.event.id;
      const a = document.getElementById('downloadIcs');
      a.classList.remove('disabled');
      a.href = `${API_BASE}/api/events/${info.event.id}/ics`;
    }
  });
  calendar.render();
});

document.getElementById('filterBtn').onclick = async () => {
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;
  const status = document.getElementById('status').value;
  const events = await fetchEvents({ from, to, status });
  calendar.removeAllEvents();
  calendar.addEventSource(events);
};

document.getElementById('createBtn').onclick = async () => {
  const title = document.getElementById('title').value.trim();
  const start_time = document.getElementById('start').value;
  const end_time = document.getElementById('end').value;
  const roomId = document.getElementById('room').value || null;
  const parts = Array.from(document.getElementById('parts').selectedOptions).map(o=>o.value);
  if (!title || !start_time || !end_time) return alert('Nhập đủ tiêu đề và thời gian');
  const res = await api.post('/api/events', { title, start_time, end_time, roomId, participantIds: parts });
  alert('Đã tạo: ' + res.data.title);
  location.reload();
};

async function updateStatus(status) {
  const id = document.getElementById('eventId').value;
  if (!id) return alert('Chọn Event ID');
  await api.put(`/api/events/${id}`, { status });
  location.reload();
}
document.getElementById('approveBtn').onclick = () => updateStatus('approved');
document.getElementById('rejectBtn').onclick = () => updateStatus('rejected');
</script>
</body>
</html>
