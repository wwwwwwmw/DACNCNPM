import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../models/task.dart';
import '../../models/task_assignment.dart';
import '../../services/api_service.dart';
import 'add_task_page.dart';

class TaskDetailPage extends StatefulWidget {
  final TaskModel task;
  const TaskDetailPage({super.key, required this.task});

  @override
  State<TaskDetailPage> createState() => _TaskDetailPageState();
}

class _TaskDetailPageState extends State<TaskDetailPage> {
  double? _progressDraft;

  @override
  Widget build(BuildContext context) {
    final api = context.watch<ApiService>();
    final currentUser = api.currentUser;
    final task = widget.task;
    final assignments = task.assignments;
  final acceptedCount = assignments.where((a) => a.status == 'accepted' || a.status == 'completed').length;
  final isFull = acceptedCount >= task.capacity;
    final myAsg = currentUser == null ? null : assignments.where((a) => a.userId == currentUser.id).cast<TaskAssignmentModel?>().firstWhere((_)=>true, orElse: ()=>null);

    return Scaffold(
      appBar: AppBar(title: const Text('Task Detail')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: SingleChildScrollView(
          child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
            Text(task.title, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            if (task.description != null) Text(task.description!),
            const SizedBox(height: 16),
            Wrap(spacing:8, runSpacing: 8, children: [
              Chip(label: Text(task.status.replaceAll('_',' '))),
              Chip(label: Text('Priority: ${task.priority}')),
              Chip(label: Text('Type: ${task.assignmentType}')),
              Chip(label: Text('Slots: $acceptedCount / ${task.capacity}')),
              if (isFull) Chip(label: const Text('Đủ người'), backgroundColor: Colors.green.shade100),
            ]),
            const SizedBox(height: 16),
            if (task.startTime != null) Text('Start: ${task.startTime}'),
            if (task.endTime != null) Text('End: ${task.endTime}'),
            const SizedBox(height: 24),

            // Employee actions
            if (currentUser != null && currentUser.role == 'employee') ...[
              if (task.assignmentType == 'open' && myAsg == null) ...[
                ElevatedButton.icon(
                  onPressed: (isFull || task.status == 'completed') ? null : () async {
                    await context.read<ApiService>().applyTask(task.id);
                    if (mounted) Navigator.pop(context); // return to reload list
                  },
                  icon: const Icon(Icons.how_to_reg),
                  label: const Text('Apply for this task'),
                )
              ],
              if (myAsg != null && myAsg.status == 'assigned') ...[
                ElevatedButton.icon(
                  onPressed: (isFull || task.status == 'completed') ? null : () async {
                    await context.read<ApiService>().acceptTask(task.id);
                    if (mounted) Navigator.pop(context);
                  },
                  icon: const Icon(Icons.check_circle),
                  label: const Text('Accept assignment'),
                )
              ],
              if (myAsg != null && (myAsg.status == 'assigned' || myAsg.status == 'accepted') && myAsg.status != 'completed') ...[
                const SizedBox(height: 8),
                ElevatedButton.icon(
                  style: ElevatedButton.styleFrom(backgroundColor: Colors.redAccent),
                  onPressed: () async {
                    final reason = await _askRejectReason(context);
                    if (reason != null && reason.trim().isNotEmpty) {
                      await context.read<ApiService>().rejectTask(task.id, reason.trim());
                      if (mounted) Navigator.pop(context);
                    }
                  },
                  icon: const Icon(Icons.block),
                  label: const Text('Từ chối nhiệm vụ'),
                )
              ],
              if (myAsg != null) ...[
                const SizedBox(height: 12),
                Text('Your progress: ${(myAsg.progress)}%'),
                Slider(
                  min: 0,
                  max: 100,
                  divisions: 20,
                  value: (_progressDraft ?? myAsg.progress.toDouble()).clamp(0,100),
                  onChanged: (task.status == 'completed' || myAsg.status == 'completed') ? null : (v) => setState(() { _progressDraft = v; }),
                  label: '${(_progressDraft ?? myAsg.progress).round()}%',
                ),
                ElevatedButton.icon(
                  onPressed: (task.status == 'completed' || myAsg.status == 'completed') ? null : () async {
                    final value = (_progressDraft ?? myAsg.progress.toDouble()).round();
                    await context.read<ApiService>().updateTaskProgress(task.id, value);
                    if (mounted) Navigator.pop(context);
                  },
                  icon: const Icon(Icons.save),
                  label: const Text('Update progress'),
                )
              ]
            ],

            // Manager/Admin actions
            if (currentUser != null && (currentUser.role == 'manager' || currentUser.role == 'admin')) ...[
              const SizedBox(height: 16),
              Text('Assignments', style: Theme.of(context).textTheme.titleMedium),
              const SizedBox(height: 8),
              if (assignments.isEmpty) const Text('No assignments yet'),
              ...assignments.map((a) => ListTile(
                leading: const Icon(Icons.person_outline),
                title: Text(a.user?.name ?? a.userId),
                subtitle: Text('${a.status} • ${a.progress}%'),
              )),
              const SizedBox(height: 8),
              ElevatedButton.icon(
                onPressed: () async {
                  final selected = await _pickUser(context);
                  if (selected != null) {
                    await context.read<ApiService>().assignTask(task.id, selected);
                    if (mounted) Navigator.pop(context);
                  }
                },
                icon: const Icon(Icons.person_add_alt_1),
                label: const Text('Assign user'),
              ),
              const SizedBox(height: 8),
              ElevatedButton.icon(
                onPressed: () {
                  Navigator.push(context, MaterialPageRoute(builder: (_) => AddTaskPage(editing: task)));
                },
                icon: const Icon(Icons.edit),
                label: const Text('Edit Task'),
              ),
            ] else ...[
              const SizedBox(height: 24),
              ElevatedButton.icon(
                onPressed: () {
                  Navigator.push(context, MaterialPageRoute(builder: (_) => AddTaskPage(editing: task)));
                },
                icon: const Icon(Icons.edit),
                label: const Text('Edit'),
              )
            ]
          ]),
        ),
      ),
    );
  }

  Future<String?> _askRejectReason(BuildContext context) async {
    final ctrl = TextEditingController();
    return showDialog<String>(context: context, builder: (ctx) {
      return AlertDialog(
        title: const Text('Lý do từ chối'),
        content: TextField(controller: ctrl, maxLines: 3, decoration: const InputDecoration(hintText: 'Nhập lý do...')),
        actions: [
          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Hủy')),
          ElevatedButton(onPressed: () => Navigator.pop(ctx, ctrl.text), child: const Text('Gửi')),
        ],
      );
    });
  }

  Future<String?> _pickUser(BuildContext context) async {
    final api = context.read<ApiService>();
    final users = await api.listUsers(limit: 100);
    // If manager, filter to own department users
    final me = api.currentUser;
    final filtered = (me != null && me.role == 'manager' && me.departmentId != null)
        ? users.where((u) => u.departmentId == me.departmentId).toList()
        : users;
    return showDialog<String>(context: context, builder: (ctx) {
      return SimpleDialog(title: const Text('Assign to user'), children: [
        ...filtered.map((u) => SimpleDialogOption(onPressed: () => Navigator.pop(ctx, u.id), child: Text(u.name)))
      ]);
    });
  }
}
